<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chinese Rookie Battle - Zendo</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      height: 100%;
      width: 100%;
      background: url(icebg.jpg);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .game-area {
      position: relative;
      width: 90%;
      max-width: 900px;
      min-height: 72vh;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      margin-top: 20px;
      padding-bottom: 120px;
    }

    .battle-scene {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .boss-container {
      position: absolute;
      bottom: 0px;
      z-index: 1;
    }

    .boss {
      width: 60vw;
      max-width: 540px;
      aspect-ratio: 1/1;
      background-image: url("boss.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      image-rendering: pixelated;
      opacity: 0.9;
    }

    .character-container {
      position: absolute;
      bottom: 0px;
      z-index: 4;
    }

    .character {
      width: 15vw;
      max-width: 120px;
      aspect-ratio: 1/1;
      background-image: url("chara.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      image-rendering: pixelated;
    }

    /* Boss health at top */
    .boss-health-top {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      max-width: 800px;
      height: 20px;
      background: #444;
      border-radius: 10px;
      overflow: hidden;
      z-index: 20;
    }

    .boss-health-top .health {
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #ff0000, #ff6666);
      transition: width 0.4s ease;
    }

    /* Player hearts */
    .player-hearts {
      position: fixed;
      bottom: 240px;
      left: 20px;
      display: flex;
      gap: 5px;
      z-index: 20;
    }

    .player-hearts img {
      width: 32px;
      height: 32px;
    }

    .question-box {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 220px;
      background: linear-gradient(to top, rgba(180, 220, 255, 0.95), rgba(230, 250, 255, 0.85));
      border-top: 2px solid #aee6ff;
      box-shadow: 0 -6px 20px rgba(150, 220, 255, 0.5);
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 10;
      backdrop-filter: blur(8px) brightness(1.2);
      border-radius: 20px 20px 0 0;
    }

    .answers {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-top: 5px;
      width: 100%;
    }

    .answers button, #actionBtn {
      background: linear-gradient(to bottom, #d0f4ff, #90e0ef);
      color: #023e8a;
      border: 1px solid #caf0f8;
      border-radius: 12px;
      padding: 12px 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 180, 255, 0.3), inset 0 -2px 6px rgba(255,255,255,0.6);
    }

    .answers button:hover, #actionBtn:hover {
      background: linear-gradient(to bottom, #e0faff, #a5e6f0);
      transform: scale(1.05);
      box-shadow: 0 6px 14px rgba(0, 180, 255, 0.5), inset 0 -2px 6px rgba(255,255,255,0.8);
    }

    .answers button:active, #actionBtn:active {
      transform: translateY(2px);
      box-shadow: 0 4px #2c80b4, 0 4px 6px rgba(0,0,0,0.25);
    }

    .rocket, .boss-missile {
      position: absolute;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      display: none;
    }

    .rocket {
      width: 200px;
      height: 200px;
      background-image: url('MagicAtt.png');
      z-index: 3;
    }

    .boss-missile {
      width: 150px;
      height: 150px;
      background-image: url('BossAtt.png');
      z-index: 2;
    }

    .dead {
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    .fadeout { opacity: 0; }

    .fragment {
      position: absolute;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      pointer-events: none;
      animation: explode 0.5s forwards;
    }

    @keyframes explode {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
    }

    #actionBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #3498db;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.2s ease;
      z-index: 1000;
      box-shadow: 0 6px #2c80b4, 0 6px 10px rgba(0,0,0,0.3);
      display: none;
    }

    #actionBtn:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 8px #2c80b4, 0 8px 12px rgba(0,0,0,0.35);
    }

    #actionBtn:active {
      transform: translateY(2px);
      box-shadow: 0 4px #2c80b4, 0 4px 6px rgba(0,0,0,0.25);
    }

    .damage {
      animation: hitFlash 0.3s;
    }

    @keyframes hitFlash {
      0% { filter: brightness(2); }
      50% { filter: brightness(0.5); }
      100% { filter: brightness(1); }
    }

    #selectedWords {
      margin: 5px 0;
      min-height: 40px;
      border: 1px dashed #aaa;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
      align-items: center;
      background: rgba(255,255,255,0.05);
      box-sizing: border-box;
      max-height: none;
      overflow-y: auto;
    }

    .word-pool {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .word-pool button.selected {
      opacity: 0.3;
      pointer-events: none;
    }

    .multiple-choice {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 10px;
    }

    .answer-word {
      background: #3498db;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: grab;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: transform 0.15s;
    }

    .answer-word:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .dragging {
      opacity: 0.6;
    }

    .placeholder {
      width: 60px;
      height: 35px;
      border: 2px dashed #aaa;
      border-radius: 8px;
      margin: 2px;
    }
  </style>
</head>
<body>
<button id="pause-btn" style="position:fixed;top:24px;left:32px;z-index:1000;padding:12px 24px;font-size:1.4rem;border-radius:8px;background:#4a90e2;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">&#124; &#124;</button>
<div id="pause-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,50,0.85);z-index:2000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:18px;padding:40px 32px;box-shadow:0 8px 32px #23294699;min-width:280px;max-width:90vw;text-align:center;">
    <h2 style="color:#4a90e2;margin-bottom:24px;">Game Paused</h2>
    <button id="resume-btn" style="margin:12px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#4a90e2;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Resume</button><br>
    <button id="restart-btn" style="margin:18px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#ffd54f;color:#232946;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Restart</button><br>
    <button id="exit-btn" style="margin:18px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#e57373;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Exit</button>
  </div>
</div>

  <!-- Boss health -->
  <div class="boss-health-top">
    <div class="health" id="bossHealthTop"></div>
  </div>

  <!-- Player hearts -->
  <div class="player-hearts" id="playerHearts">
    <img src="heart.png">
    <img src="heart.png">
    <img src="heart.png">
    <img src="heart.png">
    <img src="heart.png">
  </div>

  <div class="game-area">
    <div class="battle-scene">
      <div class="boss-container">
        <div class="boss" id="boss"></div>
      </div>
      <div class="character-container">
        <div class="character" id="player"></div>
      </div>
    </div>
    <div class="rocket" id="rocket"></div>
    <div class="boss-missile" id="bossRocket"></div>
  </div>

  <div class="question-box" id="questionBox">
    <p id="questionText">Loading question...</p>
    <div class="answers" id="answersContainer"></div>
    <button id="actionBtn">Submit</button>
  </div>

    <!-- Celebratory Popup Modal -->
  <div id="victoryModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,50,0.85);z-index:3000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:24px;padding:48px 32px;box-shadow:0 8px 32px #23294699;min-width:280px;max-width:90vw;text-align:center;animation:popIn 0.5s cubic-bezier(.4,1.6,.4,1);">
      <h2 style="color:#4a90e2;font-size:2.2rem;margin-bottom:18px;">🎉 You have defeated the boss! 🎉</h2>
      <p style="font-size:1.25rem;color:#232946;margin-bottom:24px;">Congratulations! You completed the challenge.</p>
      <button id="victoryCloseBtn" style="padding:14px 38px;font-size:1.1rem;border-radius:10px;background:#4a90e2;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Continue</button>
    </div>
  </div>

  <!-- Defeat Popup Modal -->
  <div id="defeatModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,50,0.85);z-index:3000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:24px;padding:48px 32px;box-shadow:0 8px 32px #23294699;min-width:280px;max-width:90vw;text-align:center;animation:popIn 0.5s cubic-bezier(.4,1.6,.4,1);">
      <h2 style="color:#e57373;font-size:2.2rem;margin-bottom:18px;">💀 You were defeated! 💀</h2>
      <p style="font-size:1.25rem;color:#232946;margin-bottom:24px;">Don't worry, try again!</p>
      <button id="defeatCloseBtn" style="padding:14px 38px;font-size:1.1rem;border-radius:10px;background:#e57373;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Restart</button>
    </div>
  </div>
  
  <script>
    let playerHP = 5; // hearts
    let bossHP = 100; // percentage

    let paused = false;

const pauseBtn = document.getElementById('pause-btn');
const pauseModal = document.getElementById('pause-modal');
const resumeBtn = document.getElementById('resume-btn');
const restartBtn = document.getElementById('restart-btn');
const exitBtn = document.getElementById('exit-btn');

pauseBtn.onclick = function() {
  paused = true;
  pauseModal.style.display = 'flex';
};

resumeBtn.onclick = function() {
  paused = false;
  pauseModal.style.display = 'none';
};

restartBtn.onclick = function () {
  paused = false;
  pauseModal.style.display = 'none';

  // reset HP
  playerHP = 5;
  bossHP = 100;

  // restore hearts
  const hearts = document.getElementById("playerHearts").children;
  for (let i = 0; i < hearts.length; i++) {
    hearts[i].style.display = "block";
  }

  // restore boss health bar
  document.getElementById("bossHealthTop").style.width = bossHP + "%";

  // reset game state
  currentQuestion = 0;
  score = 0;

  // shuffle questions
  shuffleArray(questions);

  // reset rockets
  document.getElementById("rocket").style.display = "none";
  document.getElementById("bossRocket").style.display = "none";

  // clear "dead" classes
  document.getElementById("player").classList.remove("dead");
  document.getElementById("boss").classList.remove("dead");

  // restart first question
  loadQuestion();
};

exitBtn.onclick = function() {
  window.location.href = 'rookie.html'; // or "choose-level.html" if you prefer
};

    const questions = [
		{ type: "multiple", text: "A: 你好吗？\nB: ___。", options: ["我很好","我不去","我吃饭"], correct: 0, speak:["A: 你好吗？","我很好。"] },
		{ type: "arrange", text: "Arrange the words: I am a student", words:["学生","我","是"], correct:"我 是 学生" },
		{ type: "multiple", text: "A: 你从哪里来？\nB: 我从 ___ 来。", options:["中国","谢谢","明天"], correct:0, speak:["A: 你从哪里来？","我从中国来。"] },
		{ type:"arrange", text:"Arrange the words: She likes tea", words:["喜欢","茶","她"], correct:"她 喜欢 茶" },
		{ type:"arrange", text:"Arrange the words: 我喜欢吃饺子", words:["eat","to","dumplings","I","like"], correct:"I like to eat dumplings" },
		{ type:"arrange", text:"Arrange the words: 明天我去学校", words:["tomorrow","to","I","will","go","school"], correct:"tomorrow I will go to school" },
		{ type:"arrange", text:"Arrange the words: He is my friend", words:["他","朋友","是","我的"], correct:"他 是 我的 朋友" },
		{ type:"arrange", text:"Arrange the words: 我每天早上跑步", words:["run","every","morning","I"], correct:"I run every morning" },
		{ type:"arrange", text:"Arrange the words: I like reading books", words:["我","书","喜欢","读"], correct:"我 喜欢 读 书" },
		{ type:"arrange", text:"Arrange the words: 今天是星期五", words:["today","is","Friday"], correct:"today is Friday" },
		{ type:"arrange", text:"Arrange the words: They are playing basketball", words:["他们","打","篮球","在"], correct:"他们 在 打 篮球" },
		{ type:"arrange", text:"Arrange the words: 我们明天去公园", words:["go","to","the","park","tomorrow","we"], correct:"we go to the park tomorrow" },
		{ type:"multiple", text:"Translate: 'I like to eat dumplings.'", options:["我喜欢吃饺子","我喜欢踢足球","我会说中文"], correct:0, speak:["I like to eat dumplings.","我喜欢吃饺子。"] },
		{ type:"multiple", text:"A: 现在几点？\nB: ___。", options:["三点","北京","昨天"], correct:0, speak:["A: 现在几点？","三点。"] },
		{ type:"multiple", text:"Which one means 'library'?", options:["图书馆","教室","商店"], correct:0 },
		{ type:"multiple", text:"A: 你会说英语吗？\nB: ___。", options:["我会说英语","我不会说中文","我会说韩语"], correct:0, speak:["A: 你会说英语吗？","我会说英语。"] },
		{ type:"multiple", text:"Translate: 'Tomorrow I will go to school.'", options:["明天我去学校","今天我在家","我喜欢看电影"], correct:0, speak:["Tomorrow I will go to school.","明天我去学校。"] },
		{ type:"multiple", text:"Fill in the blank: 我喜欢喝 ___。", options:["水","书","桌子"], correct:0, speak:["我喜欢喝什么？","我喜欢喝水。"] },
		{ type:"arrange", text:"Arrange the words: I am hungry", words:["我","了","饿","死"], correct:"我 饿 死 了" },
		{ type:"arrange", text:"Arrange the words: 他在看书", words:["He","is","reading","a","book"], correct:"He is reading a book" },
		{ type:"arrange", words:["我","是","学生","一个"], correct:"我 是 一个 学生", speak:["我是一个学生。"] },
		{ type:"arrange", words:["他","喜欢","吃","苹果"], correct:"他 喜欢 吃 苹果", speak:["他喜欢吃苹果。"] },
		{ type:"arrange", words:["妈妈","在","厨房","做饭"], correct:"妈妈 在 厨房 做饭", speak:["妈妈在厨房做饭。"] },
		{ type:"arrange", words:["我们","明天","去","北京"], correct:"我们 明天 去 北京", speak:["我们明天去北京。"] },
		{ type:"arrange", words:["这","是","我的","书包"], correct:"这 是 我的 书包", speak:["这是我的书包。"] },
		{ type:"arrange", words:["他","会","说","英语"], correct:"他 会 说 英语", speak:["他会说英语。"] },
		{ type:"arrange", words:["现在","是","八点","半"], correct:"现在 是 八点 半", speak:["现在是八点半。"] },
		{ type:"arrange", words:["我","每天","六点","起床"], correct:"我 每天 六点 起床", speak:["我每天六点起床。"] },
		{ type:"arrange", words:["她","有","两只","狗"], correct:"她 有 两只 狗", speak:["她有两只狗。"] },
		{ type:"arrange", words:["我们","在","公园","玩"], correct:"我们 在 公园 玩", speak:["我们在公园玩儿。"] }
    ];

    function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}}

    shuffleArray(questions);

    let currentQuestion = 0;
    const questionText = document.getElementById('questionText');
    const answersContainer = document.getElementById('answersContainer');
    const actionBtn = document.getElementById('actionBtn');
    let isSubmitPhase = true;

    function cleanDialogue(text){return text.replace(/^[A-D][:.\s]+/,'').trim();}
    function speak(text){if('speechSynthesis' in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang='zh-CN';window.speechSynthesis.speak(u);}}

    function loadQuestion(){
      if(currentQuestion>=questions.length){questionText.textContent="🎉 You finished all questions! 🎉";answersContainer.innerHTML="";actionBtn.style.display="none";return;}
      const q=questions[currentQuestion];
      questionText.textContent=q.text;
      answersContainer.innerHTML="";
      isSubmitPhase=true;
      actionBtn.textContent="Submit";
      actionBtn.style.display="block";

      if(q.type==="multiple"&&q.speak&&q.speak[0])speak(cleanDialogue(q.speak[0]));

      if(q.type==="multiple"||!q.type){
        const optionsDiv=document.createElement("div");
        optionsDiv.classList.add("multiple-choice");
        let selectedOption=null;
        const options=[...q.options];shuffleArray(options);

        options.forEach(opt=>{
          const btn=document.createElement("button");
          btn.textContent=opt;
          btn.onclick=()=>{
            selectedOption=q.options.indexOf(opt);
            optionsDiv.querySelectorAll("button").forEach(b=>b.classList.remove("selected"));
            btn.classList.add("selected");
            if(q.speak)speak(opt);
          };
          optionsDiv.appendChild(btn);
        });
        answersContainer.appendChild(optionsDiv);
        actionBtn.onclick=()=>{
          if(isSubmitPhase){
            if(selectedOption===null)return;
            document.querySelectorAll("#answersContainer button").forEach(btn=>btn.disabled=true);
            if(selectedOption===q.correct)playerAttack();else bossAttack();
            actionBtn.textContent="Continue";isSubmitPhase=false;
          } else {currentQuestion++;loadQuestion();}
        };
      } else if(q.type==="arrange"){
			let selectedWords=[];
			const selectedDiv=document.createElement("div");
			selectedDiv.id="selectedWords";
			selectedDiv.style.display="flex";
			selectedDiv.style.flexWrap="wrap";
			selectedDiv.style.gap="5px";

			const poolDiv=document.createElement("div");
			poolDiv.classList.add("word-pool");

			// shuffle words before showing
			const shuffledWords = [...q.words];
			shuffleArray(shuffledWords);

			shuffledWords.forEach(word=>{
			const btn=document.createElement("button");
			btn.textContent=word;
			btn.dataset.selected="false";

			btn.onclick=()=>{
				if(btn.dataset.selected==="false"){
				const ansBtn=document.createElement("button");
				ansBtn.textContent=word;
				ansBtn.draggable=true;
				ansBtn.classList.add("answer-word");

				// click to remove (restore to pool)
				ansBtn.onclick=()=>{
					selectedDiv.removeChild(ansBtn);
					selectedWords=selectedWords.filter(w=>w!==word);
					btn.classList.remove("selected");
					btn.dataset.selected="false";
				};

				// drag support
				ansBtn.addEventListener("dragstart", e=>{
					e.dataTransfer.setData("text/plain", word);
					ansBtn.classList.add("dragging");
				});
				ansBtn.addEventListener("dragend", ()=>ansBtn.classList.remove("dragging"));

				selectedDiv.appendChild(ansBtn);
				selectedWords.push(word);

				btn.classList.add("selected");
				btn.dataset.selected="true";
				speak(word);

				// allow reordering
				selectedDiv.addEventListener("dragover", e=>{
				e.preventDefault();
				const dragging = document.querySelector(".dragging");
				const afterElement = getDragAfterElement(selectedDiv, e.clientX);

				if (afterElement == null) {
					selectedDiv.appendChild(dragging);
				} else {
					selectedDiv.insertBefore(dragging, afterElement);
				}
				});

				selectedDiv.addEventListener("drop", e=>{
				e.preventDefault();
				const dragging = document.querySelector(".dragging");
				if (dragging) {
					dragging.classList.remove("dragging"); // restore normal look
				}
				});

				function getDragAfterElement(container, x) {
				const draggableElements = [...container.querySelectorAll(".answer-word:not(.dragging)")];
				return draggableElements.reduce((closest, child)=>{
					const box = child.getBoundingClientRect();
					const offset = x - box.left - box.width / 2;
					if (offset < 0 && offset > closest.offset) {
					return { offset: offset, element: child };
					} else {
					return closest;
					}
				}, { offset: Number.NEGATIVE_INFINITY }).element;
				}
				}
			};
			poolDiv.appendChild(btn);
			});

			answersContainer.appendChild(selectedDiv);
			answersContainer.appendChild(poolDiv);

			actionBtn.onclick=()=>{
			if(isSubmitPhase){
				// build arranged sentence from order of selectedDiv children
				const arranged=[...selectedDiv.querySelectorAll(".answer-word")].map(btn=>btn.textContent).join(" ");
				if(arranged===q.correct) playerAttack();
				else bossAttack();

				actionBtn.textContent="Continue";
				isSubmitPhase=false;
			} else {
				currentQuestion++;
				loadQuestion();
			}
			};
		}
	}

    function playerAttack(){
      const rocket=document.getElementById("rocket"),boss=document.getElementById("boss"),bossHealth=document.getElementById("bossHealthTop"),gameArea=document.querySelector('.game-area');
      const bossRect=boss.getBoundingClientRect(),playerRect=document.getElementById("player").getBoundingClientRect(),areaRect=gameArea.getBoundingClientRect();
      let startX=playerRect.left-areaRect.left+playerRect.width/2-65;
      let startY=playerRect.top-areaRect.top+playerRect.height/2-140;
      let endX=bossRect.left-areaRect.left+bossRect.width/2;
      let endY=bossRect.top-areaRect.top+bossRect.height/2-80;
      let controlX=startX+(endX-startX)/2+100,controlY=(startY+endY)/2;
      rocket.style.display="block";let progress=0;
      function animate(){
        progress+=0.02;
        if(progress>=1){
          rocket.style.display="none";
          bossHP=Math.max(0,bossHP-10);
          bossHealth.style.width=bossHP+"%";
          boss.classList.add("damage");explode(boss);
          setTimeout(()=>boss.classList.remove("damage"),300);
          if(bossHP===0){boss.classList.add("dead");endGame(true);}
          return;
        }
        const x=(1-progress)**2*startX+2*(1-progress)*progress*controlX+progress**2*endX;
        const y=(1-progress)**2*startY+2*(1-progress)*progress*controlY+progress**2*endY;
        rocket.style.left=x+"px";rocket.style.top=y+"px";requestAnimationFrame(animate);
      }
      if (!paused) {
        progress += 0.02;
      }
      if (paused) return;
      requestAnimationFrame(animate);
    }

    function bossAttack(){
      const bossRocket=document.getElementById("bossRocket"),player=document.getElementById("player"),hearts=document.getElementById("playerHearts"),gameArea=document.querySelector('.game-area');
      const bossRect=document.getElementById("boss").getBoundingClientRect(),playerRect=player.getBoundingClientRect(),areaRect=gameArea.getBoundingClientRect();
      let startX=bossRect.left-areaRect.left+bossRect.width/2-120,startY=bossRect.top-areaRect.top+bossRect.height/2,endX=playerRect.left-areaRect.left+playerRect.width/2-80,endY=playerRect.top-areaRect.top+playerRect.height/2-80;
      let controlX=startX+(endX-startX)/2-250,controlY=startY-80+Math.random()*40;
      bossRocket.style.display="block";let progress=0;
      function animate(){
        progress+=0.02;
        if(progress>=1){
          bossRocket.style.display="none";
          playerHP=Math.max(0,playerHP-1);
          if(playerHP>=0)hearts.children[playerHP].style.display="none";
          player.classList.add("damage");explode(player);
          setTimeout(()=>player.classList.remove("damage"),300);
          if(playerHP===0){player.classList.add("dead");endGame(false);}
          return;
        }
        const x=(1-progress)**2*startX+2*(1-progress)*progress*controlX+progress**2*endX;
        const y=(1-progress)**2*startY+2*(1-progress)*progress*controlY+progress**2*endY;
        bossRocket.style.left=x+"px";bossRocket.style.top=y+"px";requestAnimationFrame(animate);
      }
      if (!paused) {
        progress += 0.02;
      }
      if (paused) return;
      requestAnimationFrame(animate);
    }

    function explode(target){
      const gameArea=document.querySelector('.game-area');const rect=target.getBoundingClientRect(),areaRect=gameArea.getBoundingClientRect();
      for(let i=0;i<20;i++){const frag=document.createElement('div');frag.classList.add('fragment');frag.style.setProperty('--x',(Math.random()-0.5)*200+'px');frag.style.setProperty('--y',(Math.random()-0.5)*200+'px');frag.style.left=rect.left-areaRect.left+rect.width/2+'px';frag.style.top=rect.top-areaRect.top+rect.height/2+'px';gameArea.appendChild(frag);setTimeout(()=>frag.remove(),500);}
    }

    function endGame(win){
      if(win){
        // Show celebratory popup
        var victoryModal = document.getElementById('victoryModal');
        var victoryCloseBtn = document.getElementById('victoryCloseBtn');
        victoryModal.style.display = 'flex';
        victoryCloseBtn.onclick = function() {
          victoryModal.style.display = 'none';
        };
      } else {
        // Show defeat modal
        const defeatModal = document.getElementById('defeatModal');
        const defeatCloseBtn = document.getElementById('defeatCloseBtn');
        defeatModal.style.display = 'flex';
        defeatCloseBtn.onclick = function() {
          defeatModal.style.display = 'none';
          // Restart game on close
          restartBtn.click();
        };
      }
    }

    loadQuestion();
  </script>
</body>
</html>
