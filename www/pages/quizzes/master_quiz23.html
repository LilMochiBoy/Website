<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Master Quiz Level 23 — Argumentation</title>
<style>
:root{
  --bg:#232946; --accent:#4a90e2; --accent2:#7f9cf5; --panel:#1b2138; --white:#f7f7fa;
}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Segoe UI",Arial,sans-serif;color:var(--white);-webkit-font-smoothing:antialiased}
.duo-header{display:flex;align-items:center;justify-content:center;gap:18px;margin-top:24px;margin-bottom:12px}
.duo-img{width:64px;height:64px;border-radius:50%;background:#fff;box-shadow:0 2px 8px #1e3c72}
.duo-title{font-size:2.0rem;font-weight:700;color:var(--accent);text-shadow:0 2px 8px #000}

/* progress */
.quiz-progress{margin:12px auto;width:80%;height:18px;background:#111426;border-radius:12px;overflow:hidden}
.quiz-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0;border-radius:12px;transition:width .28s}

/* card */
.container-wrap{display:flex;justify-content:center}
.quiz-card{width:100%;max-width:1100px;margin:22px auto 60px;padding:28px 20px 48px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.45);position:relative}
.quiz-question{font-size:1.6rem;font-weight:700;margin:18px 0 12px;text-align:center;color:var(--white);line-height:1.35}
.quiz-feedback{font-size:1.05rem;font-weight:600;color:#ffeb3b;min-height:28px;text-align:center;margin-bottom:8px}
.quiz-feedback.wrong{color:#ff3b3b;animation:buzz .3s linear 1}
@keyframes buzz{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}100%{transform:translateX(0)}}

/* answers area */
.quiz-answers{display:grid;grid-template-columns:1fr 1fr;gap:28px;padding-left:20px;padding-right:20px;margin-top:12px}

/* answer buttons (MCQ) */
.answer-btn-custom{width:100%;border-radius:8px;font-size:1.15rem;padding:18px 14px;background:var(--panel);color:var(--white);font-weight:700;border:3px solid transparent;box-shadow:0 6px 22px rgba(0,0,0,0.35);min-height:64px;position:relative;overflow:hidden;text-align:left;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,outline-color .12s}
.answer-btn-custom:disabled{opacity:.75;cursor:default}
.answer-btn-custom.selected-option{transform:scale(1.06);box-shadow:0 12px 30px rgba(74,144,226,0.18);outline:3px solid rgba(74,144,226,0.12)}
.answer-fill{position:absolute;left:0;bottom:0;width:100%;height:0%;z-index:1;transition:height .6s cubic-bezier(.4,1.4,.4,1)}
.answer-fill.c1{background:linear-gradient(0deg,#e57373 80%,#ffb3b3 100%)}
.answer-fill.c2{background:linear-gradient(0deg,#64b5f6 80%,#b3e0ff 100%)}
.answer-fill.c3{background:linear-gradient(0deg,#81c784 80%,#c8e6c9 100%)}
.answer-fill.c4{background:linear-gradient(0deg,#ffd54f 80%,#fff9c4 100%)}

/* submit / next */
.submit-btn{background:var(--accent);color:#fff;padding:12px 30px;border-radius:10px;border:none;cursor:pointer;font-weight:800;display:block;margin:18px auto 0;box-shadow:0 6px 18px rgba(0,0,0,.28)}
.submit-btn:disabled{opacity:.6;cursor:default}
.next-btn{background:#2d9a44;color:#fff;padding:10px 22px;border-radius:8px;border:none;cursor:pointer;font-weight:800;display:block;margin:12px auto 0;box-shadow:0 6px 18px rgba(0,0,0,.2)}

/* ---------- Matching area adjustments (smaller boxes moved higher) ---------- */
.match-area{width:100%;display:flex;justify-content:center;align-items:flex-start;gap:28px;margin-top:6px;position:relative}
.match-column{display:flex;flex-direction:column;gap:10px;align-items:center}
.match-box{width:150px;height:40px;border-radius:10px;background:#fff;color:#232946;display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 22px rgba(0,0,0,.25);cursor:pointer;user-select:none;transition:transform .14s ease,box-shadow .14s ease,background .14s ease,outline-color .12s;z-index:10}
.match-box.small{width:130px;height:36px;font-size:.98rem}
.match-box.matched{background:#81c784;color:#fff;cursor:default;box-shadow:0 6px 12px rgba(0,0,0,.12)}
.match-box.selected {
  transform: scale(1.15);
  box-shadow: 0 0 25px rgba(74, 144, 226, 0.55);
  outline: 3px solid rgba(74, 144, 226, 0.35);
  transition: transform 0.2s ease, box-shadow 0.3s ease, outline 0.3s ease;
  z-index: 15;
}

/* svg overlay wrap (absolute within card) */
.svg-wrap{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;overflow:visible;z-index:5}

/* buzzer effect */
.buzzer-effect { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 59, 59, 0.25); pointer-events: none; z-index: 9999; animation: screenBuzz 0.4s linear 1; }
@keyframes screenBuzz { 0% { transform: translateX(0); } 20% { transform: translateX(-16px); } 40% { transform: translateX(16px); } 60% { transform: translateX(-16px); } 80% { transform: translateX(16px); } 100% { transform: translateX(0); } }

/* arrange */
#selectedWords { margin: 5px 0; min-height: 40px; border: 1px dashed #aaa; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; align-items: center; background: rgba(255,255,255,0.03); box-sizing: border-box; max-height: none; overflow-y: auto; }
.word-pool { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }
.word-pool button.selected { opacity: 0.3; pointer-events: none; }
.answer-word { background: #3498db; color: white; padding: 8px 14px; border: none; border-radius: 8px; font-size: 16px; cursor: grab; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: transform 0.15s; user-select: none; }
.answer-word.dragging { opacity: 0.7; transform: scale(1.03); }
.placeholder-word { min-width: 60px; height: 36px; border: 2px dashed #aaa; border-radius: 8px; margin: 4px; }

/* small note */
.small-note{text-align:center;color:#cbd5e1;margin-top:8px;font-size:.95rem}

/* responsive tweaks */
@media(max-width:900px){ .match-box{width:120px;height:36px} .match-box.small{width:110px;height:32px} .quiz-card{padding:18px} .duo-title{font-size:1.6rem} .quiz-answers{gap:16px;padding-left:12px;padding-right:12px} }
</style>
</head>
<body>
<button id="pause-btn" style="position:fixed;top:24px;left:32px;z-index:1000;padding:12px 24px;font-size:1.4rem;border-radius:8px;background:var(--accent);color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">&#124; &#124;</button>
<div id="pause-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,50,0.85);z-index:2000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:18px;padding:40px 32px;box-shadow:0 8px 32px #23294699;min-width:280px;max-width:90vw;text-align:center;">
    <h2 style="color:var(--accent);margin-bottom:24px;">Game Paused</h2>
    <button id="resume-btn" style="margin:12px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:var(--accent);color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Resume</button><br>
    <button id="restart-btn" style="margin:18px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#ffd54f;color:#232946;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Restart</button><br>
    <button id="exit-btn" style="margin:18px 0 0 0;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#e57373;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;">Exit</button>
  </div>
</div>

<div class="duo-header"><img class="duo-img" src="../../assets/images/Panda.png" alt="Panda"/><div class="duo-title">Master Quiz 23: Argumentation</div></div>
<div class="quiz-progress"><div id="quiz-progress-bar" class="quiz-progress-bar"></div></div>

<div class="container-wrap">
  <div class="quiz-card" role="main" aria-live="polite">
    <div style="position:relative;">
      <div id="quiz-question" class="quiz-question"></div>
      <div class="svg-wrap" aria-hidden="true">
        <svg id="connection-svg" width="100%" height="100%"></svg>
      </div>
    </div>

    <div id="quiz-feedback" class="quiz-feedback"></div>
    <div id="quiz-answers" class="quiz-answers"></div>
    <div id="buzzer-effect-root"></div>
  </div>
</div>

<script>
/* ---------- Pause logic ---------- */
let paused = false;
const pauseBtn = document.getElementById('pause-btn');
const pauseModal = document.getElementById('pause-modal');
const resumeBtn = document.getElementById('resume-btn');
const restartBtn = document.getElementById('restart-btn');
const exitBtn = document.getElementById('exit-btn');
pauseBtn.onclick = ()=>{ paused=true; pauseModal.style.display='flex'; }
resumeBtn.onclick = ()=>{ paused=false; pauseModal.style.display='none'; }
restartBtn.onclick = ()=>{ paused=false; pauseModal.style.display='none'; current=0; score=0; initMatchState(); showQuestion(); document.getElementById('quiz-progress-bar').style.width='0%'; }
exitBtn.onclick = ()=> window.location.href='../levels/master.html';

const questions = [
  // ---------- Part A: Vocabulary Matching (Q1–10) ----------
  {
    type: 'match',
    pageTitle: 'Part A: Vocabulary (1–5)',
    items: [
      { id: 'm1', cn: '观点', en: 'opinion / viewpoint' },
      { id: 'm2', cn: '论据', en: 'evidence / argument' },
      { id: 'm3', cn: '说服', en: 'persuade' },
      { id: 'm4', cn: '理由', en: 'reason' },
      { id: 'm5', cn: '支持', en: 'support' },
    ]
  },
  {
    type: 'match',
    pageTitle: 'Part A: Vocabulary (6–10)',
    items: [
      { id: 'm6', cn: '反对', en: 'oppose' },
      { id: 'm7', cn: '因为…所以…', en: 'because… therefore…' },
      { id: 'm8', cn: '虽然…但是…', en: 'although… but…' },
      { id: 'm9', cn: '既…又…', en: 'both… and…' },
      { id: 'm10', cn: '总结', en: 'summarize' },
    ]
  },

  // ---------- Part B: Multiple Choice Grammar / Sentences (Q11–20) ----------
  { type: 'mcq', q: 'Q11: ___天气不好，所以比赛取消了。', options: ['因为', '虽然', '既', '我的观点是'], answer: 0 },
  { type: 'mcq', q: 'Q12: ___很累，但是我还是完成了作业。', options: ['虽然', '因为', '支持', '论据'], answer: 0 },
  { type: 'mcq', q: 'Q13: 这本书___有趣，___有教育意义。', options: ['既…又…', '因为…所以…', '我的观点是', '总结'], answer: 0 },
  { type: 'mcq', q: 'Q14: ___教育很重要。', options: ['我的观点是', '说服', '理由', '反对'], answer: 0 },
  { type: 'mcq', q: 'Q15: 我___这个提议，因为它有利于大家。', options: ['支持', '反对', '总结', '论据'], answer: 0 },
  { type: 'mcq', q: 'Q16: 我提供了很多___来说服对方。', options: ['论据', '理由', '观点', '支持'], answer: 0 },
  { type: 'mcq', q: 'Q17: 我反对你的观点，___它可能带来风险。', options: ['因为', '既', '虽然', '总结'], answer: 0 },
  { type: 'mcq', q: 'Q18: 我既喜欢中文，___喜欢数学。', options: ['又', '因为', '虽然', '总结'], answer: 0 },
  { type: 'mcq', q: 'Q19: 在演讲的最后，你应该___你的观点。', options: ['总结', '说服', '支持', '反对'], answer: 0 },
  { type: 'mcq', q: 'Q20: 他用很多理由___大家接受他的建议。', options: ['说服', '支持', '反对', '总结'], answer: 0 },

  // ---------- Part C: Fill in the Blanks (Q21–25) ----------
  { type: 'fill', q: 'Q21: 我的___是保护环境很重要。 (opinion)', answer: ['观点'] },
  { type: 'fill', q: 'Q22: 因为下雨，所以比赛___。 (was canceled)', answer: ['取消了'] },
  { type: 'fill', q: 'Q23: 虽然很累，但是我___完成了作业。 (still)', answer: ['还是'] },
  { type: 'fill', q: 'Q24: 这本书既有趣，___有教育意义。 (also)', answer: ['又'] },
  { type: 'fill', q: 'Q25: 我支持你的意见，因为有很多___。 (arguments)', answer: ['论据'] },

  // ---------- Part D: Translation (Q26–30) ----------
  { type: 'fill', q: 'Q26: My opinion is that protecting the environment is important.', answer: ['我的观点是保护环境很重要。'] },
  { type: 'fill', q: 'Q27: Because it rained, the game was canceled.', answer: ['因为下雨，所以比赛取消了。'] },
  { type: 'fill', q: 'Q28: Although I am tired, I still finished the homework.', answer: ['虽然很累，但是我还是完成了作业。'] },
  { type: 'fill', q: 'Q29: This book is both interesting and educational.', answer: ['这本书既有趣，又有教育意义。'] },
  { type: 'fill', q: 'Q30: I support your opinion because there are many arguments.', answer: ['我支持你的意见，因为有很多论据。'] },
];

let current = 0;
let score = 0;

/* match state */
let matchState = { connections:{}, pathMap:{}, leftSelected:null, rightSelected:null };

/* helpers */
const byId = id => document.getElementById(id);
const svg = byId('connection-svg');
const Q_ANS = byId('quiz-answers');
const Q_FB = byId('quiz-feedback');
const Q_Q = byId('quiz-question');

function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

function drawAnimatedPath(elA, elB, color='#ffd54f'){
  if(!elA || !elB) return null;
  const svgRect = svg.getBoundingClientRect();
  const aRect = elA.getBoundingClientRect();
  const bRect = elB.getBoundingClientRect();
  const ax = aRect.left + aRect.width/2 - svgRect.left;
  const ay = aRect.top + aRect.height/2 - svgRect.top;
  const bx = bRect.left + bRect.width/2 - svgRect.left;
  const by = bRect.top + bRect.height/2 - svgRect.top;
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  const cx = Math.max(40, Math.abs(bx-ax)/2);
  const d = `M ${ax} ${ay} C ${ax+cx} ${ay} ${bx-cx} ${by} ${bx} ${by}`;
  path.setAttribute('d', d);
  path.setAttribute('stroke', color);
  path.setAttribute('stroke-width', 4);
  path.setAttribute('fill','none');
  path.setAttribute('stroke-linecap','round');
  svg.appendChild(path);
  const len = path.getTotalLength();
  path.style.strokeDasharray = len;
  path.style.strokeDashoffset = len;
  requestAnimationFrame(()=>{ path.style.transition = 'stroke-dashoffset 480ms cubic-bezier(.2,.9,.2,1)'; path.style.strokeDashoffset = '0'; });
  return path;
}

window.addEventListener('resize', ()=>{ redrawMatchPaths(); });

function redrawMatchPaths(){
  clearSVG();
  for(const leftId in matchState.connections){
    const rightId = matchState.connections[leftId];
    const leftEl = byId('left-'+leftId);
    const rightEl = byId('right-'+rightId);
    if(leftEl && rightEl){
      matchState.pathMap[leftId] = drawAnimatedPath(leftEl, rightEl);
    }
  }
}

function initMatchState(){
  matchState.connections = {};
  matchState.pathMap = {};
  matchState.leftSelected = null;
  matchState.rightSelected = null;
  clearSVG();
  Q_FB.innerHTML = '';
}

/* ---------- Improved normalization helpers ----------
   This normalization:
   - trims & unicode-normalizes,
   - removes punctuation/symbols,
   - collapses whitespace,
   - lowercases Latin text,
   - removes combining diacritics (accents)
   - works for Chinese (won't break Chinese characters)
*/
function normalizeAnswer(s){
  if(!s) return '';
  // NFKC to collapse compatibility chars
  let t = String(s).trim().normalize('NFKC');

  // Remove punctuation & symbols (Unicode property escapes)
  // Note: requires modern JS engines; if unsupported, fallback below
  try {
    t = t.replace(/[\p{P}\p{S}]+/gu, '');
  } catch(e){
    // Fallback: basic ascii + common Chinese punctuation removal
    t = t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\"'<>?¡¿，。？！、；：]/g,'');
  }

  // Collapse whitespace
  t = t.replace(/\s+/g, ' ').trim();

  // Remove combining diacritics (accents)
  t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '').normalize('NFC');

  // Lowercase for latin scripts (won't affect Chinese)
  t = t.toLowerCase();

  return t;
}

/* ---------- Render questions ---------- */
function showQuestion(){
  if(paused) return;
  // if reached end -> finish
  if(current >= questions.length){ finishQuiz(); return; }

  const q = questions[current];
  Q_Q.innerHTML=''; Q_ANS.innerHTML=''; Q_FB.innerHTML=''; Q_ANS.style.gridTemplateColumns='1fr 1fr';
  updateProgress();

  // ensure no leftover mcq-control
  const oldControl = document.getElementById('mcq-control');
  if(oldControl) oldControl.remove();

  if(q.type === 'match'){
    initMatchState();
    Q_Q.innerHTML = q.pageTitle;

    // build columns
    const matchArea = document.createElement('div'); matchArea.className='match-area';
    const leftCol = document.createElement('div'); leftCol.className='match-column';
    const rightCol = document.createElement('div'); rightCol.className='match-column';
    const rightPool = q.items.slice().sort(()=>Math.random()-0.5);

    // left boxes (Chinese)
    q.items.forEach(it=>{
      const l = document.createElement('div');
      l.className = 'match-box';
      if(window.innerWidth < 900) l.classList.add('small');
      l.textContent = it.cn;
      l.id = 'left-'+it.id;
      l.dataset.id = it.id;
      l.dataset.side = 'left';
      l.addEventListener('click', ()=> {
        if(paused) return;
        // ✨ Visual pop animation
        l.style.transform = 'scale(1.2)';
        setTimeout(() => l.style.transform = '', 150);

        // 🟡 If this left box is matched → cancel its connection (both sides)
        if (l.classList.contains('matched')) {
          const matchedRightId = matchState.connections[it.id];
          if (matchedRightId) removeConnection(it.id, matchedRightId);
          return;
        }

        // Normal select behavior
        document.querySelectorAll('.match-box.selected').forEach(el => {
          if(el.dataset.side === 'left') el.classList.remove('selected');
        });
        l.classList.add('selected');
        matchState.leftSelected = it.id;

        // If right is already selected → create connection
        if(matchState.rightSelected){
          createOrRemap(matchState.leftSelected, matchState.rightSelected);
          document.querySelectorAll('.match-box.selected').forEach(el=>el.classList.remove('selected'));
          matchState.leftSelected = null;
          matchState.rightSelected = null;
        }
      });
      leftCol.appendChild(l);
    });

    // right boxes (English) (random order)
    rightPool.forEach(it=>{
      const r = document.createElement('div');
      r.className = 'match-box';
      if(window.innerWidth < 900) r.classList.add('small');
      r.textContent = it.en;
      r.id = 'right-'+it.id;
      r.dataset.id = it.id;
      r.dataset.side = 'right';
      r.addEventListener('click', ()=> {
        if(paused) return;
        // ✨ Visual pop animation
        r.style.transform = 'scale(1.2)';
        setTimeout(() => r.style.transform = '', 150);

        // 🟡 If this right box is matched → cancel its connection (both sides)
        const matchedLeftId = Object.keys(matchState.connections)
          .find(lid => matchState.connections[lid] === it.id);
        if (matchedLeftId) {
          removeConnection(matchedLeftId, it.id);
          return;
        }

        // Normal select behavior
        document.querySelectorAll('.match-box.selected').forEach(el => {
          if(el.dataset.side === 'right') el.classList.remove('selected');
        });
        r.classList.add('selected');
        matchState.rightSelected = it.id;

        // If left is already selected → create connection
        if(matchState.leftSelected){
          createOrRemap(matchState.leftSelected, matchState.rightSelected);
          document.querySelectorAll('.match-box.selected').forEach(el=>el.classList.remove('selected'));
          matchState.leftSelected = null;
          matchState.rightSelected = null;
        }
      });
      rightCol.appendChild(r);
    });

    matchArea.appendChild(leftCol);
    matchArea.appendChild(rightCol);

    Q_ANS.style.gridTemplateColumns = '1fr';
    Q_ANS.appendChild(matchArea);

    const note = document.createElement('div');
    note.className = 'small-note';
    note.textContent = 'Click a Chinese box (left), then an English box (right) to connect. Remap by connecting again. Connect all 5 then press Submit.';
    Q_ANS.appendChild(note);

    // Create a fresh submit button for this match page
    const submit = document.createElement('button');
    submit.className = 'submit-btn';
    submit.textContent = 'Submit';
    submit.disabled = false;

    let matchScored = false; // Prevent double scoring

    submit.addEventListener('click', function onMatchSubmit(){
      if(paused) return;
      if(!matchScored) {
        // Only allow submit if all 5 are connected
        const total = q.items.length;
        const userConnections = Object.keys(matchState.connections).length;
        if(userConnections < total) {
          Q_FB.innerHTML = `<span class="wrong">❗ Connect all ${total} pairs before submitting.</span>`;
          setTimeout(()=> Q_FB.textContent='', 1200);
          return;
        }
        // grade
        let correct = 0;
        q.items.forEach(it => { if(matchState.connections[it.id] === it.id) correct++; });
        Q_FB.innerHTML = `<div style="font-weight:700;color:#ffe600;text-align:center">You connected ${correct} / ${total}</div>`;
        score += correct;
        matchScored = true;
        // switch to Next state
        submit.textContent = 'Next';
      } else {
        // clear visuals & paths
        clearSVG();
        document.querySelectorAll('.match-box').forEach(m => { m.classList.remove('matched','selected'); });
        // advance
        current++;
        showQuestion();
      }
    });
    Q_ANS.appendChild(submit);
    return;
  }

  // MCQ block (submit disabled until user selects an option)
  if(q.type === 'mcq'){
    Q_Q.innerHTML = q.q;
    Q_ANS.style.gridTemplateColumns='1fr 1fr';

    // Shuffle options and track the new answer index
    const optionObjs = (q.options || []).map((opt, i) => ({
        text: opt,
        origIndex: i
    }));
    // Fisher-Yates shuffle
    for (let i = optionObjs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [optionObjs[i], optionObjs[j]] = [optionObjs[j], optionObjs[i]];
    }
    // Find new answer index
    const newAnswerIndex = optionObjs.findIndex(o => o.origIndex === q.answer);

    optionObjs.forEach((optObj,i)=>{
        const btn = document.createElement('button'); btn.className='answer-btn-custom';
        btn.textContent = `${String.fromCharCode(65+i)}. ${optObj.text}`;
        const fill = document.createElement('div'); fill.className = `answer-fill c${(i%4)+1}`; btn.appendChild(fill);
        btn.addEventListener('click', ()=> {
            if(paused) return;
            if(btn.disabled) return;
            document.querySelectorAll('.answer-btn-custom').forEach(b=> b.classList.remove('selected-option'));
            btn.classList.add('selected-option');
            let control = document.getElementById('mcq-control');
            if(!control){ control = document.createElement('div'); control.id='mcq-control'; control.style.display='none'; document.body.appendChild(control); }
            control.dataset.selected = String(i); // store as non-empty string
        });
        Q_ANS.appendChild(btn);
    });

    const controls = document.createElement('div'); controls.style.gridColumn='1 / -1'; controls.style.display='flex'; controls.style.justifyContent='center'; controls.style.flexDirection='column'; controls.style.alignItems='center';
    const submitBtn = document.createElement('button'); submitBtn.className='submit-btn'; submitBtn.textContent='Submit'; submitBtn.id='mcq-submit';
    // Pass newAnswerIndex and optionObjs to handler
    submitBtn.addEventListener('click', ()=> handleMcqSubmitToggle(submitBtn, q, newAnswerIndex, optionObjs));
    controls.appendChild(submitBtn);
    Q_ANS.appendChild(controls);
    return;
  }

  // arrange/drag questions (part C)
  if(q.type === 'drag'){
    Q_Q.innerHTML = q.q;
    Q_ANS.style.gridTemplateColumns='1fr';
    const selectedDiv = document.createElement('div'); selectedDiv.id = 'selectedWords';
    const poolDiv = document.createElement('div'); poolDiv.className = 'word-pool';
    const shuffled = q.words.slice().sort(()=>Math.random()-0.5);

    shuffled.forEach((word, idx) => {
      const btn = document.createElement('button');
      btn.textContent = word;
      btn.type = 'button';
      btn.className = 'answer-btn-custom border-c1'; // Use same box style as MCQ/match
      btn.style.width = "110px";
      btn.style.minHeight = "38px";
      btn.style.fontSize = "1.1rem";
      btn.style.margin = "0 4px 4px 0";
      btn.style.textAlign = "center";
      btn.addEventListener('click', () => {
        if(btn.classList.contains('selected')) return;
        const ansBtn = document.createElement('button');
        ansBtn.textContent = word;
        ansBtn.className = 'answer-btn-custom border-c1'; // Use same box style
        ansBtn.style.width = "110px";
        ansBtn.style.minHeight = "38px";
        ansBtn.style.fontSize = "1.1rem";
        ansBtn.style.margin = "0 4px 4px 0";
        ansBtn.style.textAlign = "center";
        ansBtn.setAttribute('draggable', 'true');

        ansBtn.addEventListener('click', () => {
          selectedDiv.removeChild(ansBtn);
          btn.classList.remove('selected');
        });

        ansBtn.addEventListener('dragstart', (e) => {
          ansBtn.classList.add('dragging');
          e.dataTransfer.setData('text/plain', 'dragging'); // marker
          window._dragging = ansBtn;
        });
        ansBtn.addEventListener('dragend', (e) => {
          ansBtn.classList.remove('dragging');
          window._dragging = null;
        });

        selectedDiv.appendChild(ansBtn);
        btn.classList.add('selected');
      });
      poolDiv.appendChild(btn);
    });

    selectedDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      const dragging = window._dragging;
      if(!dragging) return;
      const children = Array.from(selectedDiv.querySelectorAll('.answer-btn-custom'));
      let insertBefore = null;
      for(const child of children){
        if(child === dragging) continue;
        const rect = child.getBoundingClientRect();
        const mid = rect.left + rect.width/2;
        if(e.clientX < mid){ insertBefore = child; break; }
      }
      if(insertBefore) selectedDiv.insertBefore(dragging, insertBefore); else selectedDiv.appendChild(dragging);
    });
    selectedDiv.addEventListener('drop', e => e.preventDefault());

    Q_ANS.appendChild(selectedDiv);
    Q_ANS.appendChild(poolDiv);

    const submit = document.createElement('button'); submit.className='submit-btn'; submit.textContent='Submit';
    submit.addEventListener('click', ()=> {
      if(paused) return;
      if(submit.textContent === 'Submit'){
        const arranged = Array.from(selectedDiv.querySelectorAll('.answer-btn-custom')).map(b => b.textContent.trim()).join(' ');
        // Use same normalization for drag-type comparison
        const normalize = s => normalizeAnswer(s).replace(/\s+/g,' ').trim();
        const arrangedNorm = normalize(arranged);

        // Support multiple correct answers
        const correctAnswers = Array.isArray(q.correct) ? q.correct : [q.correct];
        const isCorrect = correctAnswers.some(ans => normalize(ans) === arrangedNorm);

        if (isCorrect) {
          Q_FB.innerHTML = `<span style="color:#ffe600;font-weight:700">Correct! 🎉</span>`;
          score++;
        } else {
          Q_FB.innerHTML = `<span class="wrong">Incorrect — correct answer(s): ${correctAnswers.join('  /  ')}</span>`;
          const buz = document.createElement('div');
          buz.className='buzzer-effect';
          byId('buzzer-effect-root').appendChild(buz);
          setTimeout(()=> buz.remove(),700);
        }
        submit.textContent = 'Next';
        submit.onclick = ()=> { current++; showQuestion(); };
      }
    });
    Q_ANS.appendChild(submit);
    return;
  }

    // ---------- FILL-IN-THE-BLANK QUESTION ----------
  if(q.type === 'fill'){
    Q_Q.innerHTML = q.q;
    Q_ANS.style.gridTemplateColumns = '1fr';

    // Input box
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Type your answer here...';
    input.style.width = '70%';
    input.style.margin = '12px auto';
    input.style.padding = '14px';
    input.style.fontSize = '1.2rem';
    input.style.textAlign = 'center';
    input.style.borderRadius = '10px';
    input.style.border = '2px solid var(--accent)';
    input.style.background = '#fff';
    input.style.color = '#000';
    input.style.display = 'block';
    Q_ANS.appendChild(input);

    // Submit button
    const submit = document.createElement('button');
    submit.className = 'submit-btn';
    submit.textContent = 'Submit';
    Q_ANS.appendChild(submit);

    submit.addEventListener('click', () => {
      if(paused) return;

      const userAns = input.value.trim();
      if(!userAns){
        Q_FB.innerHTML = `<span class="wrong">❗ Please type your answer first</span>`;
        setTimeout(()=> Q_FB.textContent='',900);
        return;
      }

      // Use improved normalization
      const normalize = normalizeAnswer;
      const userNorm = normalize(userAns);

      const correctAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
      const isCorrect = correctAnswers.some(ans => normalize(ans) === userNorm);

      if(isCorrect){
        Q_FB.innerHTML = `<span style="color:#ffe600;font-weight:700">Correct! 🎉</span>`;
        score++;
        input.style.borderColor = '#4caf50';
      } else {
        Q_FB.innerHTML = `<span class="wrong">Incorrect — correct: ${correctAnswers.join(' / ')}</span>`;
        input.style.borderColor = '#ff3b3b';
        const buz = document.createElement('div');
        buz.className = 'buzzer-effect';
        byId('buzzer-effect-root').appendChild(buz);
        setTimeout(()=> buz.remove(),700);
      }

      // Change to Next button
      submit.textContent = 'Next';
      submit.onclick = ()=> { current++; showQuestion(); };
    });

    return;
  }

  Q_Q.innerHTML = 'Unknown question type';
}

	/* ---------- Matching helpers ---------- */
	function createOrRemap(leftId,rightId){
	// remove any existing connection for leftId or rightId (one-to-one)
	if(matchState.connections[leftId]) removeConnection(leftId, matchState.connections[leftId]);
	for(const l in matchState.connections){ if(matchState.connections[l] === rightId){ removeConnection(l,rightId); break; } }
	matchState.connections[leftId] = rightId;
	const leftEl = byId('left-'+leftId); const rightEl = byId('right-'+rightId);
	if(leftEl) leftEl.classList.add('matched');
	if(rightEl) rightEl.classList.add('matched');
	if(matchState.pathMap[leftId]){ try{ matchState.pathMap[leftId].remove(); }catch(e){} }
	const p = drawAnimatedPath(leftEl, rightEl);
	matchState.pathMap[leftId] = p;
	}
  function removeConnection(leftId, rightId) {
    // Remove stored link
    delete matchState.connections[leftId];

    // Get the line path and connected boxes
    const leftEl = byId('left-' + leftId);
    const rightEl = byId('right-' + rightId);
    const path = matchState.pathMap[leftId];
    delete matchState.pathMap[leftId];

    // 🧊 Smooth line fade-out before removal
    if (path) {
      path.style.transition = 'opacity 0.25s ease-out';
      path.style.opacity = '0';
      setTimeout(() => {
        try { path.remove(); } catch (e) {}
      }, 250);
    }

    // 🟢 Smoothly un-highlight both boxes
    [leftEl, rightEl].forEach(el => {
      if (el) {
        el.style.transition = 'background 0.25s, color 0.25s, transform 0.25s';
        el.classList.remove('matched', 'selected');
        el.style.transform = 'scale(0.92)';
        setTimeout(() => {
          el.style.transform = 'scale(1)';
        }, 150);
      }
    });
  }

	/* ---------- MCQ handler with robust selection check ---------- */
	function handleMcqSubmitToggle(submitBtn, qObj, answerIndex, optionObjs){
    if(paused) return;
    if(submitBtn.dataset.answered === "true") return; // Prevent double scoring

    const control = document.getElementById('mcq-control');
    const sel = control ? control.dataset.selected : undefined;
    if(!control || sel === undefined || sel === ''){
        Q_FB.innerHTML = `<span class="wrong">❗ Please select an option first</span>`;
        setTimeout(()=> Q_FB.textContent='',900);
        return;
    }
    const selectedIndex = parseInt(sel,10);
    if(isNaN(selectedIndex)){
        Q_FB.innerHTML = `<span class="wrong">❗ Please select an option first</span>`;
        setTimeout(()=> Q_FB.textContent='',900);
        return;
    }
    const allBtns = Array.from(document.querySelectorAll('.answer-btn-custom'));
    allBtns.forEach((b, idx) => {
        if(idx === answerIndex) b.style.borderColor = '#4caf50';
        if(idx === selectedIndex && idx !== answerIndex) b.style.borderColor = '#ff3b3b';
        b.disabled = true;
    });
    if(selectedIndex === answerIndex){
        const fill = allBtns[selectedIndex].querySelector('.answer-fill');
        if(fill) fill.style.height = '100%';
        Q_FB.innerHTML = `<span style="color:#ffe600;font-weight:700">Correct! 🎉</span>`;
        score++; // Only increment once
    } else {
        // Show correct answer text
        Q_FB.innerHTML = `<span class="wrong">Incorrect — correct: ${String.fromCharCode(65+answerIndex)}. ${optionObjs[answerIndex].text}</span>`;
        const buz = document.createElement('div'); buz.className='buzzer-effect'; byId('buzzer-effect-root').appendChild(buz);
        setTimeout(()=> buz.remove(),700);
    }
    submitBtn.textContent = 'Next';
    submitBtn.dataset.answered = "true"; // Mark as answered
    submitBtn.onclick = ()=> {
        const control2 = document.getElementById('mcq-control');
        if(control2) control2.remove();
        current++;
        showQuestion();
    };
	}

/* ---------- Progress & finish ---------- */
	function updateProgress() {
		const bar = document.getElementById('quiz-progress-bar');
		bar.style.width = ((current / questions.length) * 100) + '%';
	}

	function setUnlockedLevel(level) {
		localStorage.setItem('masterUnlockedLevel', String(level));
		// If logged in, update backend
		var username = localStorage.getItem('masterUserId');
		if (username) {
			fetch('http://localhost:3000/api/updateProgress', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({ username, unlockedLevel: level })
			});
		}
	}

	// Calculate total possible score (1 point per item in match, 1 per other question)
	const totalScore = questions.reduce((sum, q) => sum + (q.type === 'match' ? q.items.length : 1), 0);

	function finishQuiz() {
    document.getElementById('quiz-question').innerHTML = '';
    document.getElementById('quiz-answers').innerHTML = '';
    document.getElementById('quiz-feedback').innerHTML = `<div class='quiz-finish'>Quiz Complete!<br>Your score: ${score} / ${totalScore}<br><br>🐼 Panda is proud of you!<br><button id='nextLevelBtn' style='margin-top:18px;padding:12px 32px;font-size:1.1rem;border-radius:8px;background:#4a90e2;color:#fff;border:none;box-shadow:0 2px 8px #222;cursor:pointer;'>Next Level</button></div>`;
    document.getElementById('quiz-progress-bar').style.width = '100%';
    setUnlockedLevel(2);
    setTimeout(function() {
        var btn = document.getElementById('nextLevelBtn');
        if (btn) {
            btn.onclick = function() {
                window.location.href = 'master_quiz24.html';
            };
        }
    }, 100);
}
	// Start the quiz
	paused = false;
	showQuestion();
</script>
</body>
</html>